"""
Calculator Plugin for Jarvis AI
Provides advanced calculator functionality.
"""

from typing import Callable

PLUGIN_TRIGGERS = [
    "calculate",
    "what is",
    "solve",
    "math",
    "arithmetic",
    "compute",
    "add",
    "subtract",
    "multiply",
    "divide",
    "square root",
    "power of"
]

PLUGIN_METADATA = {
    "name": "Advanced Calculator",
    "version": "1.2.0",
    "author": "Jarvis AI Team",
    "description": "Advanced calculator with scientific functions",
    "category": "Utilities"
}

def PLUGIN_FUNCTION(text: str, speak: Callable) -> str:
    """
    Main calculator function.
    """
    import re
    import math
    
    # Extract mathematical expression
    patterns = [
        r"calculate\s+(.+)",
        r"what is\s+(.+)",
        r"solve\s+(.+)",
        r"compute\s+(.+)"
    ]
    
    expression = ""
    for pattern in patterns:
        match = re.search(pattern, text, re.IGNORECASE)
        if match:
            expression = match.group(1).strip()
            break
    
    # If no pattern matched, use the entire text
    if not expression:
        expression = text
    
    # Clean up expression
    expression = expression.replace("plus", "+")
    expression = expression.replace("minus", "-")
    expression = expression.replace("times", "*")
    expression = expression.replace("multiplied by", "*")
    expression = expression.replace("divided by", "/")
    expression = expression.replace("square root", "sqrt")
    expression = expression.replace("power of", "**")
    expression = expression.replace("to the power", "**")
    expression = expression.replace("squared", "**2")
    expression = expression.replace("cubed", "**3")
    
    # Remove non-math words
    math_words = ["calculate", "what", "is", "solve", "compute", "please", "could you", "would you", "hey"]
    for word in math_words:
        expression = re.sub(fr'\b{word}\b', '', expression, flags=re.IGNORECASE)
    
    expression = expression.strip()
    
    if not expression:
        message = "Please provide a mathematical expression to calculate."
        speak(message)
        return message
    
    try:
        # Replace sqrt with math.sqrt
        expression_eval = expression
        if "sqrt" in expression_eval:
            def sqrt_func(match):
                return f"math.sqrt({match.group(1)})"
            expression_eval = re.sub(r'sqrt\(([^)]+)\)', sqrt_func, expression_eval)
            expression_eval = re.sub(r'sqrt\s+([^+\-*/]+)', r'math.sqrt(\1)', expression_eval)
        
        # Evaluate safely
        allowed_names = {
            'math': math,
            'sqrt': math.sqrt,
            'sin': math.sin,
            'cos': math.cos,
            'tan': math.tan,
            'pi': math.pi,
            'e': math.e
        }
        
        # Compile expression
        code = compile(expression_eval, "<string>", "eval")
        
        # Check for allowed names
        for name in code.co_names:
            if name not in allowed_names:
                raise NameError(f"Use of {name} not allowed")
        
        result = eval(code, {"__builtins__": {}}, allowed_names)
        
        message = f"The result of {expression} is {result:.4f}" if isinstance(result, float) else f"The result of {expression} is {result}"
        speak(message)
        return message
        
    except Exception as e:
        message = f"Sorry, I couldn't calculate that: {str(e)}"
        speak(message)
        return message

def PLUGIN_SETUP():
    """Setup function for calculator plugin"""
    print("ðŸ§® Calculator Plugin loaded - Ready for mathematical operations!")
    return True