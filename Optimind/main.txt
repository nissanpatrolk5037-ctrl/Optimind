from auto_coder import execute_anything as groq_code, check_internet_connection, get_llm_response
import argparse
from PyQt6.QtWidgets import QApplication
from PyQt6.QtWebEngineWidgets import QWebEngineView
from PyQt6.QtWebChannel import QWebChannel
from PyQt6.QtCore import QObject, pyqtSlot, QUrl, Qt
from pwd_guard import run_password_guard
from live_screen import live_screen
from memory import log_conversation
from api_integrations import *
from age import run_age_guard
from typing import Optional, Any
from functools import lru_cache
from speak import speak
from triggers import *
import scipy.io.wavfile as wav
from data import API_KEY
import clap as clap
from docx import Document
import sounddevice as sd
from pathlib import Path
import datetime as dt
from groq import Groq
from plugin import (
    plugin_manager,
    load_plugins,
    check_plugin_triggers,
    execute_plugin_function,
    get_loaded_plugins
)
from PIL import Image
import urllib.request
import numpy as np
import subprocess
import threading
import tempfile
import requests
import qrcode
import queue
import time
import sys
import os



# ================= CONSTANTS =================
IS_WINDOWS = sys.platform.startswith("win")
IS_MACOS = sys.platform == "darwin"
IS_LINUX = sys.platform.startswith("linux")
# ================= WHISPER STT CONFIG =================
WHISPER_EXE = Path("D:/Optimind_AI/whisper-cpp/whisper-cli.exe")
MODEL_DIR = Path("D:/Optimind_AI/models/whisper-models/")

# Define model files
MODELS = {
    "tiny": MODEL_DIR / "ggml-tiny.en.bin",
    "small": MODEL_DIR / "ggml-small.en.bin", 
    "base": MODEL_DIR / "ggml-base.en.bin",
    "medium": MODEL_DIR / "ggml-medium.en.bin"
}

# Model selection based on duration (in seconds)
MODEL_SELECTION = {
    (0, 5): "tiny",      # 0-5 seconds
    (6, 10): "small",    # 6-10 seconds
    (11, 20): "base",    # 11-20 seconds
    (21, float('inf')): "medium"  # 21+ seconds
}

SAMPLERATE = 16000
CHANNELS = 1

VOICE_THRESHOLD = 0.015      # Voice detection threshold
SILENCE_SECONDS = 1.8        # Stop after this many seconds of silence
MIN_SPEECH_SECONDS = 0.5     # Minimum speech to process
# =====================================================
HTML_UI_PATH = "d:/Optimind_AI/gui.html"
# ------------------- GLOBALS -------------------
audio_queue = queue.Queue()
stop_listening = threading.Event()
tts_playing = threading.Event()

def rms(x):
    return np.sqrt(np.mean(x * x))

# ------------------- WHISPER TRANSCRIBE FUNCTION -------------------
def transcribe_whisper(audio):
    """Transcribe audio using Whisper with adaptive model selection"""
    duration = len(audio) / SAMPLERATE
    
    # Select model based on duration
    for (min_dur, max_dur), model_name in MODEL_SELECTION.items():
        if min_dur <= duration <= max_dur:
            model_path = MODELS[model_name]
            if model_path.exists():
                print(f"üìä Using {model_name} model for {duration:.1f}s audio")
                break
    else:
        # Fallback to medium
        model_path = MODELS["medium"]
        model_name = "medium"
    
    if not model_path.exists():
        print(f"‚ùå Error: Model {model_name} not found at {model_path}")
        return ""
    
    # Convert to int16 for WAV
    audio_int16 = np.int16(audio * 32767)
    
    # Save temporary WAV file
    with tempfile.NamedTemporaryFile(suffix=".wav", delete=False) as f:
        wav.write(f.name, SAMPLERATE, audio_int16)
        wav_path = f.name

    # Prepare output prefix
    out_prefix = Path(wav_path).with_suffix("")
    
    # Run whisper-cpp
    cmd = [
        str(WHISPER_EXE),
        "-m", str(model_path),
        wav_path,
        "-of", str(out_prefix),
        "--output-txt"
    ]
    
    # Transcribe
    print(f"   Transcribing with {model_name}...", end="", flush=True)
    start_time = time.time()
    subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    transcribe_time = time.time() - start_time
    print(f" done in {transcribe_time:.1f}s")

    # Read transcription
    txt = out_prefix.with_suffix(".txt")
    if txt.exists():
        text = txt.read_text(encoding="utf-8").strip()
        txt.unlink()
    else:
        text = ""

    # Clean up
    Path(wav_path).unlink()
    return text

def _print_err(*args, **kwargs) -> None:
    msg = args[0] if args else kwargs.get("msg", "")
    try:
        print(f"[ERROR] {msg}")
    except Exception:
        pass

# ------------------- GROQ FUNCTIONS -------------------
def _make_session() -> requests.Session:
    session = requests.Session()

    retries = requests.adapters.Retry(
        total=3,
        backoff_factor=0.5,
        status_forcelist=(429, 500, 502, 503, 504),
        allowed_methods=frozenset(["GET", "POST"])
    )

    adapter = requests.adapters.HTTPAdapter(
        max_retries=retries,
        pool_connections=10,
        pool_maxsize=10
    )

    session.mount("http://", adapter)
    session.mount("https://", adapter)

    session.headers.update({
        "User-Agent": "OptimindAI/1.0"
    })

    return session

SESSION = _make_session()

def groq_answer(instructions: str, query: Optional[str] = None) -> str:
    """Get answer using Groq (online) or local LLM (offline)"""
    return get_llm_response(instructions, query) or ""

# ============================================================================
# MEDIA FUNCTIONS
# ============================================================================

class Media():
    def image_generation():
        """
        Generate an image using Pollinations AI based on a reduced prompt.
        """
        query = input("Enter a prompt for your image: ")
        if not query:
            _print_err("No query provided for image generation.")
            return None

        out_path = input("Enter a path for your image to be saved to: ")

        try:
            obj = groq_answer(
                "Just return the primary object from this query. "
                "E.g., 'create a dog' -> 'dog'",
                query,
            )
        except Exception:
            obj = None

        obj = (obj or "").strip() or query

        img_url = f"https://image.pollinations.ai/prompt/{requests.utils.quote(obj)}"

        try:
            with SESSION.get(img_url, stream=True, timeout=15) as response:
                response.raise_for_status()

                Path(out_path).parent.mkdir(parents=True, exist_ok=True)

                with open(out_path, "wb") as f:
                    for chunk in response.iter_content(chunk_size=1024 * 32):
                        if chunk:
                            f.write(chunk)

            if Image is not None:
                try:
                    Image.open(out_path).verify()
                except Exception:
                    _print_err("Downloaded file may not be a valid image.")

                try:
                    Image.open(out_path).show()
                except Exception:
                    pass

            return out_path

        except Exception as e:
            _print_err(f"Failed to download image: {e}")
            return None

    def qrCodeGenerator():
        input_text_link = input("Enter a text or link: ")
        if qrcode is None:
            print("Error: 'qrcode' library not installed.")
            return
        if not input_text_link.strip():
            print("Error: No text or link provided.")
            return

        try:
            fname = Path(dt.datetime.now().strftime("%Y-%m-%d_%H-%M-%S") + "-QrCode.png")
            qr = qrcode.QRCode(version=1, error_correction=qrcode.constants.ERROR_CORRECT_L, box_size=15, border=4)
            qr.add_data(input_text_link)
            qr.make(fit=True)
            img = qr.make_image(fill_color="black", back_color="white")
            img.save(fname)

            try:
                if IS_WINDOWS:
                    os.startfile(str(fname))
                elif IS_MACOS:
                    subprocess.run(["open", str(fname)], check=False, timeout=5, stderr=subprocess.DEVNULL)
                elif IS_LINUX:
                    subprocess.run(["xdg-open", str(fname)], check=False, timeout=5, stderr=subprocess.DEVNULL)
                else:
                    print(f"Saved QR: {fname.name}. File opening skipped (unsupported OS).")
            except Exception:
                print(f"Saved QR: {fname.name}. Could not open file automatically.")

            print(f"Saved QR and opened file: {fname.name}")
        except Exception as e:
            _print_err(f"QR generation failed: {e}")

    def analyze_and_report():
        """
        Simplified interactive version.
        """
        if Document is None:
            return "python-docx not available."
        
        print("=== CSV Analysis and Report Generator ===\n")
        
        csv_file = input("Enter CSV file path: ").strip()
        if not csv_file:
            return "No CSV file specified."
        
        csv_path = Path(csv_file)
        if not csv_path.is_file():
            return f"CSV file not found: {csv_file}"
        
        default_report = csv_path.stem + "_AI_Report.docx"
        report_file = input(f"Enter output report file (default: {default_report}): ").strip()
        if not report_file:
            report_file = default_report
        
        instructions = input("Any specific analysis instructions? (press Enter for general analysis): ").strip()
        
        try:
            csv_text = csv_path.read_text(encoding="utf-8", errors="ignore")
            
            base_prompt = "Analyze the following CSV data and generate a detailed report."
            if instructions:
                prompt = f"{base_prompt} {instructions}:"
            else:
                prompt = f"{base_prompt} Include key findings, trends, patterns, and recommendations:"
            
            print("Generating AI analysis...")
            report_content = groq_answer(prompt, csv_text)
            
            if not report_content:
                return "AI analysis returned no content."
            
            doc = Document()
            doc.add_heading("AI-Generated Report", level=1)
            
            doc.add_paragraph(f"Source: {csv_path.name}")
            doc.add_paragraph(f"Generated: {dt.datetime.now().strftime('%Y-%m-%d %H:%M')}")
            doc.add_paragraph("")
            
            for line in report_content.split('\n'):
                if line.strip():
                    doc.add_paragraph(line.strip())
            
            doc.save(report_file)
            
            print(f"‚úÖ Report saved as: {report_file}")
            return f"‚úÖ Report saved as: {report_file}"
            
        except Exception as e:
            return f"‚ùå Error: {str(e)}"

    def wordcloud_generator():
        """
        Simplified interactive word cloud generator.
        """
        print("=== Word Cloud Generator (Simple) ===\n")
        
        file_path = input("Enter path to text/csv/doc/pdf file: ").strip()
        if not file_path:
            return "No file specified."
        
        if not Path(file_path).exists():
            return f"File not found: {file_path}"
        
        default_output = str(Path(file_path).stem + "_wordcloud.png")
        output_path = input(f"Output file (default: {default_output}): ").strip()
        if not output_path:
            output_path = default_output
        
        show = input("Display after generation? (y/n, default: y): ").strip().lower()
        show = not (show and show.startswith('n'))
        
        bg_color = input("Background color (white/black/gray or #hexcode, default: white): ").strip()
        if not bg_color:
            bg_color = "white"
        
        mask_path = None
        mask_input = input("Mask image path (optional, press Enter to skip): ").strip()
        if mask_input and Path(mask_input).exists():
            mask_path = mask_input
        
        ext = Path(file_path).suffix.lower()
        
        try:
            if ext in [".txt", ".md"]:
                text = Path(file_path).read_text(encoding="utf-8", errors="ignore")
            elif ext == ".csv":
                import pandas as pd
                df = pd.read_csv(file_path)
                text = " ".join(df.iloc[:, 0].astype(str).tolist())
            else:
                text = Path(file_path).read_text(encoding="utf-8", errors="ignore")
        except Exception as e:
            return f"Error reading file: {e}"
        
        try:
            from wordcloud import WordCloud
            import matplotlib.pyplot as plt
            
            wc_params = {
                'background_color': bg_color,
                'max_words': 500,
                'width': 800,
                'height': 600,
            }
            
            if mask_path:
                from PIL import Image
                import numpy as np
                mask_array = np.array(Image.open(mask_path))
                wc_params['mask'] = mask_array
            
            wc = WordCloud(**wc_params).generate(text)
            
            wc.to_file(output_path)
            
            if show:
                plt.figure(figsize=(10, 8))
                plt.imshow(wc, interpolation="bilinear")
                plt.axis("off")
                plt.show()
            
            return f"Word cloud saved to: {output_path}"
            
        except ImportError as e:
            return f"Required library not found: {e}. Install with: pip install wordcloud matplotlib"
        except Exception as e:
            return f"Error generating word cloud: {e}"
    
    def audio_generation():
        import melody as melody
        melody.main()

# ------------------- SMART PARSER -------------------
def smart_parser(raw_text):
    instructions = f'''You Must do only two things, first, 
    when the text im going to give is based on a chat or conversation, 
    you can respond normally like a normal chatbot, 
    but the second thing is that if the user is asking 
    you to do some task automation, YOU MUST ONLY RETURN "<task_automation_code_requested>"
    and only that, nothing else, after i send my text. 
    dont mention a single thing about this first instruction i gave you, okay.'''

    # Use the hybrid LLM response function
    chat_code = get_llm_response(instructions, raw_text)

    if chat_code == "<task_automation_code_requested>":
        # Check if we're online before trying to execute code
        if check_internet_connection():
            output = groq_code(raw_text)
            print(f"\nü§ñ Automation Output: {output}\n")
        else:
            print("\nAutomation requires internet connection. Please connect to the internet.\n")
    else:
        print(f"\nüí≠ Assistant: {chat_code}\n")
        speak(chat_code)
        tts_playing.clear()

# ------------------- AUDIO CAPTURE THREAD -------------------
def audio_capture_thread():
    """Continuously capture audio in a separate thread"""
    try:
        with sd.InputStream(
            samplerate=SAMPLERATE,
            channels=CHANNELS,
            blocksize=int(SAMPLERATE * 0.1),
        ) as stream:
            while not stop_listening.is_set():
                data, _ = stream.read(int(SAMPLERATE * 0.1))
                audio_queue.put(data[:, 0])
    except Exception as e:
        print(f"Audio capture error: {e}")

def manage_plugins():
    """Interactive plugin management"""
    print("\nüîå Plugin Management")
    print("=====================")
    
    plugins = get_loaded_plugins()
    
    if not plugins:
        print("No plugins loaded.")
        return
    
    for i, plugin in enumerate(plugins, 1):
        print(f"{i}. {plugin['name']} v{plugin['version']}")
        print(f"   Author: {plugin['author']}")
        print(f"   Description: {plugin['description']}")
        print(f"   Triggers: {', '.join(plugin['triggers'][:3])}{'...' if len(plugin['triggers']) > 3 else ''}")
        print()
    
    choice = input("Enter plugin number to manage (or 'r' to reload all, 'q' to quit): ").strip().lower()
    
    if choice == 'q':
        return
    elif choice == 'r':
        print("Reloading all plugins...")
        plugin_manager.reload_plugins()
        print("Plugins reloaded successfully!")
    elif choice.isdigit():
        idx = int(choice) - 1
        if 0 <= idx < len(plugins):
            plugin_name = list(plugin_manager.plugins.keys())[idx]
            print(f"\nSelected: {plugins[idx]['name']}")
            action = input("Unload this plugin? (y/n): ").strip().lower()
            if action == 'y':
                if plugin_manager.unload_plugin(plugin_name):
                    print(f"Plugin '{plugins[idx]['name']}' unloaded.")
                else:
                    print("Failed to unload plugin.")

# ------------------- LISTENER WORKER -------------------
def listener_worker():
    """
    Whisper-based STT with adaptive model selection
    """
    # Check internet status
    if check_internet_connection():
        print("‚úÖ Online mode: Using Groq API for responses")
    else:
        print("üì¥ Offline mode: Using local LLM for responses")
    
    # Load plugins
    plugin_manager.load_all_plugins()
    
    print("üéôÔ∏è Whisper STT with adaptive models loaded")
    print("Models: tiny (0-5s), small (6-10s), base (11-20s), medium (21s+)")
    print("üîå Plugins loaded: Press 'p' to manage plugins")
    print("\nStart speaking...\n")

    # State for speech detection
    is_speaking = False
    audio_buffer = []
    last_voice_time = time.time()
    
    while not stop_listening.is_set():
        try:
            # Skip processing if TTS is playing
            if tts_playing.is_set():
                time.sleep(0.05)
                continue
            
            # Get audio chunk from queue
            try:
                samples = audio_queue.get(timeout=0.05)
            except queue.Empty:
                continue
            
            energy = rms(samples)
            current_time = time.time()
            
            # Voice detected
            if energy > VOICE_THRESHOLD:
                if not is_speaking:
                    # Start of speech
                    is_speaking = True
                    audio_buffer = samples.tolist()
                    last_voice_time = current_time
                    print("üé§ Listening...", end=" ", flush=True)
                else:
                    # Continue speaking
                    audio_buffer.extend(samples.tolist())
                    duration = len(audio_buffer) / SAMPLERATE
                    print(f"\rüé§ Listening... {duration:.1f}s", end="", flush=True)
                
                last_voice_time = current_time
                
            elif is_speaking:
                # We're in speech mode but this chunk is quiet
                audio_buffer.extend(samples.tolist())
                
                # Check for end of speech
                silence_duration = current_time - last_voice_time
                if silence_duration >= SILENCE_SECONDS:
                    # End of speech detected
                    audio_array = np.array(audio_buffer)
                    duration = len(audio_array) / SAMPLERATE
                    
                    if duration >= MIN_SPEECH_SECONDS:
                        print(f"\nüìä Captured {duration:.1f}s of audio")
                        
                        # Transcribe with Whisper
                        text = transcribe_whisper(audio_array)
                        
                        if text:
                            # Exit commands
                            if text.lower() in ["exit", "quit", "stop listening"]:
                                print("\nüëã Exiting...")
                                stop_listening.set()
                                break
                            
                            # Plugin management command
                            if text.lower() in ["manage plugins", "plugin manager", "show plugins", "plugins"]:
                                manage_plugins()
                                continue
                            
                            # ============================================================================
                            # TRIGGER HANDLING
                            # ============================================================================

                            triggered = False

                            # Media triggers
                            if any(trigger in text.lower() for trigger in screen_triggers):
                                print("üëÅÔ∏è Analyzing screen...")
                                live_screen()
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in image_triggers):
                                Media.image_generation()
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in qr_code_triggers):
                                Media.qrCodeGenerator()
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in wordcloud_triggers):
                                Media.wordcloud_generator()
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in report_triggers):
                                Media.analyze_and_report()
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in audio_triggers):
                                Media.audio_generation()
                                triggered = True

                            # ========== ORIGINAL API TRIGGERS ==========
                            
                            if any(trigger in text.lower() for trigger in aws_triggers):
                                print("‚òÅÔ∏è AWS Control...")
                                result = aws_control(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in google_drive_triggers):
                                print("üìÅ Uploading to Google Drive...")
                                result = upload_to_google_drive(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in calendar_triggers):
                                print("üìÖ Scheduling Google Calendar event...")
                                result = schedule_google_calendar_event(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in discord_triggers):
                                print("üí¨ Sending Discord message...")
                                result = send_discord_message(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in whatsapp_triggers):
                                print("üì± Sending WhatsApp message...")
                                result = send_whatsapp_message(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in email_triggers):
                                print("üìß Sending email...")
                                result = send_email(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in bulk_email_triggers):
                                print("üì® Sending multiple emails...")
                                result = send_multiple_emails(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in attachment_triggers):
                                print("üìé Downloading email attachments...")
                                result = download_email_attachments(text)
                                print(result)
                                triggered = True

                            # ========== NEW API TRIGGERS ==========
                            
                            # Communication Integrations
                            if any(trigger in text.lower() for trigger in slack_triggers):
                                print("üí¨ Sending Slack message...")
                                result = send_slack_message(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in twitter_triggers):
                                print("üê¶ Posting tweet...")
                                result = post_tweet(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in telegram_triggers):
                                print("üì± Sending Telegram message...")
                                # send_telegram_message is not defined in api_integrations.py
                                # Add it if you want this functionality
                                print("‚ùå Telegram integration not available yet")
                                triggered = True
                            
                            # Cloud & Infrastructure
                            if any(trigger in text.lower() for trigger in github_triggers):
                                print("üêô Creating GitHub repository...")
                                result = github_create_repo(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in azure_triggers):
                                print("‚òÅÔ∏è Controlling Azure VM...")
                                result = azure_vm_control(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in dropbox_triggers):
                                print("üì¶ Uploading to Dropbox...")
                                result = dropbox_upload(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in docker_triggers):
                                print("üê≥ Controlling Docker container...")
                                result = docker_container_control(text)
                                print(result)
                                triggered = True
                            
                            # AI & Processing
                            if any(trigger in text.lower() for trigger in openai_triggers):
                                print("ü§ñ Chatting with OpenAI...")
                                result = openai_chat(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in translate_triggers):
                                print("üåê Translating text...")
                                result = translate_text(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in wikipedia_triggers):
                                print("üìö Searching Wikipedia...")
                                result = wikipedia_search(text)
                                print(result)
                                triggered = True
                            
                            # Media & Files
                            if any(trigger in text.lower() for trigger in youtube_triggers):
                                print("üìπ Downloading YouTube video...")
                                result = youtube_download(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in qr_triggers):
                                print("üì± Generating QR code...")
                                result = qr_code_generate(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in pdf_triggers):
                                print("üìÑ Creating PDF...")
                                result = pdf_create(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in screenshot_triggers):
                                print("üì∏ Taking screenshot...")
                                result = screenshot(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in ocr_triggers):
                                print("üîç Running OCR on image...")
                                result = image_ocr(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in video_convert_triggers):
                                print("üé¨ Converting video...")
                                result = video_convert(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in audio_extract_triggers):
                                print("üéµ Extracting audio from video...")
                                result = audio_extract(text)
                                print(result)
                                triggered = True
                            
                            # Data & Analysis
                            if any(trigger in text.lower() for trigger in excel_triggers):
                                print("üìä Excel operations...")
                                result = excel_operations(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in database_triggers):
                                print("üóÑÔ∏è Database query...")
                                result = database_query(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in data_viz_triggers):
                                print("üìà Data visualization...")
                                result = data_visualization(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in weather_triggers):
                                print("üå§Ô∏è Getting weather info...")
                                result = weather_info(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in stock_triggers):
                                print("üìà Getting stock price...")
                                result = stock_price(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in currency_triggers):
                                print("üí± Converting currency...")
                                result = currency_convert(text)
                                print(result)
                                triggered = True
                            
                            # Security & Utilities
                            if any(trigger in text.lower() for trigger in encrypt_triggers):
                                print("üîí Encrypting/decrypting file...")
                                result = encrypt_decrypt_file(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in password_triggers):
                                print("üîê Generating password...")
                                result = password_generate(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in url_shorten_triggers):
                                print("üîó Shortening URL...")
                                result = url_shorten(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in domain_lookup_triggers):
                                print("üåê Looking up domain info...")
                                result = domain_lookup(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in hash_triggers):
                                print("üîè Generating hash...")
                                result = hash_generate(text)
                                print(result)
                                triggered = True
                            
                            # System & Network
                            if any(trigger in text.lower() for trigger in system_info_triggers):
                                print("üíª Getting system info...")
                                result = system_info(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in process_control_triggers):
                                print("‚öôÔ∏è Controlling processes...")
                                result = process_control(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in backup_triggers):
                                print("üíæ Backing up files...")
                                result = backup_files(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in network_scan_triggers):
                                print("üåê Scanning network...")
                                result = network_scan(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in ssh_triggers):
                                print("üñ•Ô∏è Executing SSH command...")
                                result = ssh_execute(text)
                                print(result)
                                triggered = True
                            
                            # Automation
                            if any(trigger in text.lower() for trigger in web_scrape_triggers):
                                print("üåê Web scraping...")
                                result = web_scrape(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in file_ops_triggers):
                                print("üìÅ File operations...")
                                result = file_operations(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in git_triggers):
                                print("üêô Git operations...")
                                result = git_operations(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in api_test_triggers):
                                print("üîß Testing API...")
                                result = api_test(text)
                                print(result)
                                triggered = True
                            
                            if any(trigger in text.lower() for trigger in log_analyze_triggers):
                                print("üìä Analyzing logs...")
                                result = log_analyze(text)
                                print(result)
                                triggered = True

                            # ============================================================================
                            # PLUGIN HANDLING (MUST BE PLACED HERE - after all other triggers)
                            # ============================================================================
                            if not triggered:
                                plugin_info = check_plugin_triggers(text)
                                if plugin_info:
                                    plugin_name = plugin_info['plugin_name']
                                    plugin_data = plugin_info['plugin_data']
                                    plugin_func = plugin_info['function']
                                    
                                    print(f"üîå Plugin triggered: {plugin_data['name']}")
                                    print(f"   Trigger: {plugin_info['trigger']}")
                                    
                                    try:
                                        result = plugin_func(text, speak)
                                        triggered = True
                                        
                                        # Log plugin execution
                                        log_conversation(f"[Plugin: {plugin_name}] {text}", result or "Plugin executed")
                                        
                                    except Exception as e:
                                        print(f"‚ùå Plugin execution error: {e}")
                                        speak(f"Sorry, I encountered an error with the {plugin_data['name']} plugin.")

                            # If no triggers matched, use smart parser
                            if not triggered:
                                print(f"üìù {text}")
                                smart_parser(text)
                                log_conversation(text, "")
                    
                    # Reset for next utterance
                    is_speaking = False
                    audio_buffer = []
                    print("\nStart speaking...")
        
        except Exception as e:
            print(f"Listener error: {e}")
            is_speaking = False
            audio_buffer = []

def process_prompt(prompt: str) -> str:
    response = get_llm_response(prompt)
    return response


class LLMBridge(QObject):
    @pyqtSlot(str, result=str)
    def get_response(self, prompt: str) -> str:
        return process_prompt(prompt)


# ===============================
# GUI Mode
# ===============================

def gui_mode():
    app = QApplication(sys.argv)
    view = QWebEngineView()
    view.load(QUrl.fromLocalFile(os.path.abspath(HTML_UI_PATH)))
    view.resize(900, 600)
    view.setWindowTitle("Optimind AI")
    view.setFocusPolicy(Qt.FocusPolicy.StrongFocus)

    channel = QWebChannel()
    bridge = LLMBridge()
    channel.registerObject("bridge", bridge)
    view.page().setWebChannel(channel)

    view.show()
    sys.exit(app.exec())

def main():
    clap.wait_for_double_sound()
    run_password_guard()
    run_age_guard()

    parser = argparse.ArgumentParser(description="Optimind AI Assistant")
    parser.add_argument(
        "--gui", 
        action="store_true",
        help="Launch GUI interface (default is terminal mode)"
    )
    
    args = parser.parse_args()
    
    if args.gui:
        gui_mode()
    else:
        assert WHISPER_EXE.exists(), f"Whisper executable not found at {WHISPER_EXE}"
        for model_name, model_path in MODELS.items():
            if not model_path.exists():
                print(f"‚ö†Ô∏è Warning: Model {model_name} not found at {model_path}")
        
        # Start audio capture thread
        capture_thread = threading.Thread(target=audio_capture_thread, daemon=True)
        capture_thread.start()
        
        # Start listener worker in main thread
        listener_worker()

if __name__ == "__main__":
    main()


